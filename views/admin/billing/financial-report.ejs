<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<% 
  var filters = (typeof filters !== 'undefined') ? filters : { from: (typeof startDate !== 'undefined' ? startDate : ''), to: (typeof endDate !== 'undefined' ? endDate : ''), collector_id: '' };
  var summary = (typeof summary !== 'undefined') ? summary : { total_amount: 0, remittance_count: 0 };
  var perCollector = (typeof perCollector !== 'undefined') ? perCollector : [];
  var recent = (typeof recent !== 'undefined') ? recent : [];
%>
<div class="container-fluid">
    <div class="row">
        <%- include('../../partials/billing-sidebar') %>
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content py-4">
    <h3 class="mb-3">Laporan Keuangan - Setoran Kolektor</h3>

    <form class="row g-2 align-items-end mb-3">
        <div class="col-auto">
            <label class="form-label">Dari</label>
            <input type="date" class="form-control" name="from" value="<%= filters.from %>">
        </div>
        <div class="col-auto">
            <label class="form-label">Sampai</label>
            <input type="date" class="form-control" name="to" value="<%= filters.to %>">
        </div>
        <div class="col-auto">
            <label class="form-label">Kolektor</label>
            <select class="form-select" name="collector_id">
                <option value="">Semua</option>
                <% (perCollector||[]).forEach(function(r){ %>
                    <option value="<%= r.collector_id %>" <%= String(filters.collector_id)===String(r.collector_id)?'selected':'' %>><%= r.collector_name %></option>
                <% }) %>
            </select>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary">Terapkan</button>
            <button class="btn btn-outline-secondary" type="button" id="exportSummary">Export CSV</button>
        </div>
    </form>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted">Total Setoran</div>
                    <div class="h4">Rp <%= Number(summary.total_amount||0).toLocaleString('id-ID') %></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted">Jumlah Transaksi</div>
                    <div class="h4"><%= Number(summary.remittance_count||0) %></div>
                </div>
            </div>
        </div>
    </div>

    <h5>Ringkasan per Kolektor</h5>
    <div class="table-responsive mb-4">
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Kolektor</th>
                <th>Jumlah Setoran</th>
                <th>Transaksi</th>
            </tr>
            </thead>
            <tbody>
            <% (perCollector||[]).forEach(function(r){ %>
                <tr>
                    <td><%= r.collector_name %></td>
                    <td>Rp <%= Number(r.total_amount||0).toLocaleString('id-ID') %></td>
                    <td><%= r.remittance_count %></td>
                </tr>
            <% }) %>
            </tbody>
        </table>
    </div>

    <h5>Setoran Terakhir</h5>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>Tanggal</th>
                <th>Kolektor</th>
                <th>Metode</th>
                <th>Jumlah</th>
                <th>Catatan</th>
            </tr>
            </thead>
            <tbody>
            <% (recent||[]).forEach(function(r){ %>
                <tr>
                    <td><%= r.received_at %></td>
                    <td><%= r.collector_name %></td>
                    <td><%= r.payment_method %></td>
                    <td>Rp <%= Number(r.amount||0).toLocaleString('id-ID') %></td>
                    <td><%= r.notes || '' %></td>
                </tr>
            <% }) %>
            </tbody>
        </table>
    </div>
        </main>
    </div>
</div>

<script>
document.getElementById('exportSummary').addEventListener('click', function(){
    const rows = [['Collector','Total Amount','Count']].concat((<%- JSON.stringify(perCollector||[]) %>).map(r=>[
        r.collector_name,
        r.total_amount,
        r.remittance_count
    ]));
    const csv = rows.map(r=>r.map(x=>`"${String(x ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'collector-remittance-summary.csv'; a.click();
    URL.revokeObjectURL(url);
});
</script>
