<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Pelanggan - <%= appSettings.companyHeader %></title>
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#0B1437">
    <link rel="apple-touch-icon" href="/img/icons/icon-192.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin-mobile-billing.css">
    <style>
        .map-container {
            height: calc(100vh - 140px);
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .map-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .map-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }
        
        .map-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }
        
        .map-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .map-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }
        
        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 1000;
        }
        
        .map-control-btn {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #2c3e50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .map-control-btn:hover {
            background: white;
            transform: scale(1.1);
        }
        
        .map-control-btn:active {
            transform: scale(0.95);
        }
        
        .map-legend {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .legend-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .legend-active { background: #28a745; }
        .legend-inactive { background: #dc3545; }
        .legend-suspended { background: #ffc107; }
        .legend-pending { background: #17a2b8; }
        
        .map-stats {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .customer-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .customer-marker:hover {
            transform: scale(1.2);
            z-index: 200;
        }
        
        .customer-marker.active {
            transform: scale(1.3);
            z-index: 300;
        }
        
        .customer-popup {
            position: absolute;
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 0.8rem;
            max-width: 200px;
            z-index: 400;
            display: none;
        }
        
        .popup-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }
        
        .popup-info {
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .popup-actions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .popup-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-view {
            background: #007bff;
            color: white;
        }
        
        .btn-edit {
            background: #28a745;
            color: white;
        }
        
        .search-bar {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .search-input {
            border: 2px solid #e9ecef;
            border-radius: 25px;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            width: 100%;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .filter-tab {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #6c757d;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-tab.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        
        @media (max-width: 480px) {
            .map-container {
                height: calc(100vh - 120px);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-tabs {
                flex-direction: column;
            }
            
            .map-legend {
                bottom: 0.5rem;
                left: 0.5rem;
                right: 0.5rem;
                padding: 0.75rem;
            }
            
            .map-controls {
                top: 0.5rem;
                right: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <a href="/admin/billing/mobile" class="text-white me-3">
                    <i class="bi bi-arrow-left" style="font-size: 1.2rem;"></i>
                </a>
                <div>
                    <h4 class="mb-1">Peta Pelanggan</h4>
                    <p class="mb-0 opacity-75">Lokasi pelanggan di peta</p>
                </div>
            </div>
            <div class="text-end">
                <i class="bi bi-geo-alt" style="font-size: 1.5rem; opacity: 0.8;"></i>
            </div>
        </div>
    </div>

    <div class="container-fluid px-3">
        <!-- Map Stats -->
        <div class="map-stats">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value text-success">25</div>
                    <div class="stat-label">Pelanggan Aktif</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-warning">3</div>
                    <div class="stat-label">Suspend</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-info">5</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-danger">2</div>
                    <div class="stat-label">Nonaktif</div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-bar">
            <div class="position-relative">
                <i class="bi bi-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Cari pelanggan..." id="searchInput">
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <div class="filter-tab active" data-filter="all">
                <i class="bi bi-list me-1"></i>Semua
            </div>
            <div class="filter-tab" data-filter="active">
                <i class="bi bi-check-circle me-1"></i>Aktif
            </div>
            <div class="filter-tab" data-filter="suspended">
                <i class="bi bi-pause-circle me-1"></i>Suspend
            </div>
            <div class="filter-tab" data-filter="inactive">
                <i class="bi bi-x-circle me-1"></i>Nonaktif
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div class="map-placeholder" id="mapPlaceholder">
                <i class="bi bi-geo-alt map-icon"></i>
                <h3 class="map-title">Peta Pelanggan</h3>
                <p class="map-subtitle">Klik marker untuk melihat detail pelanggan</p>
            </div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="map-control-btn" onclick="centerMap()" title="Pusatkan Peta">
                    <i class="bi bi-geo-alt"></i>
                </button>
                <button class="map-control-btn" onclick="zoomIn()" title="Zoom In">
                    <i class="bi bi-plus"></i>
                </button>
                <button class="map-control-btn" onclick="zoomOut()" title="Zoom Out">
                    <i class="bi bi-dash"></i>
                </button>
                <button class="map-control-btn" onclick="toggleFullscreen()" title="Fullscreen">
                    <i class="bi bi-fullscreen"></i>
                </button>
            </div>
            
            <!-- Map Legend -->
            <div class="map-legend">
                <div class="legend-title">Status Pelanggan</div>
                <div class="legend-item">
                    <div class="legend-color legend-active"></div>
                    <span>Aktif</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-suspended"></div>
                    <span>Suspend</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-pending"></div>
                    <span>Pending</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-inactive"></div>
                    <span>Nonaktif</span>
                </div>
            </div>
            
            <!-- Customer Markers (Real Data) -->
            <% if (customers && customers.length > 0) { %>
                <% customers.forEach(function(customer, index) { %>
                    <div class="customer-marker legend-<%= customer.status || 'inactive' %>" 
                         style="top: <%= 20 + (index * 15) %>%; left: <%= 20 + (index * 20) %>%;" 
                         data-customer="<%= customer.id || customer.phone %>" 
                         onclick="showCustomerPopup('<%= customer.id || customer.phone %>', this)">
                    </div>
                <% }); %>
            <% } else { %>
                <div class="no-customers-message">
                    <i class="bi bi-geo-alt"></i>
                    <h5>Tidak ada pelanggan</h5>
                    <p>Belum ada data pelanggan untuk ditampilkan di peta</p>
                </div>
            <% } %>
            
            <!-- Customer Popup -->
            <div class="customer-popup" id="customerPopup">
                <div class="popup-title" id="popupTitle">John Doe</div>
                <div class="popup-info" id="popupInfo">Paket 50Mbps - Aktif</div>
                <div class="popup-info" id="popupAddress">Jl. Contoh No. 123</div>
                <div class="popup-actions">
                    <button class="popup-btn btn-view" onclick="viewCustomer()">Lihat</button>
                    <button class="popup-btn btn-edit" onclick="editCustomer()">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav d-md-none">
        <a class="nav-item" href="/admin/billing/mobile/customers">
            <i class="bi bi-people"></i>
            <span>Pelanggan</span>
        </a>
        <a class="nav-item" href="/admin/billing/mobile/invoices">
            <i class="bi bi-receipt"></i>
            <span>Tagihan</span>
        </a>
        <a class="nav-item home-button" href="/admin/billing/mobile">
            <i class="bi bi-house"></i>
            <span>Home</span>
        </a>
        <a class="nav-item" href="/admin/billing/mobile/payments">
            <i class="bi bi-credit-card"></i>
            <span>Bayar</span>
        </a>
        <a class="nav-item active" href="/admin/billing/mobile/map">
            <i class="bi bi-geo-alt"></i>
            <span>Map</span>
        </a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/admin-mobile-billing.js"></script>
    <script>
        // Map functions
        function centerMap() {
            showNotification('Peta dipusatkan', 'info');
        }
        
        function zoomIn() {
            showNotification('Zoom in', 'info');
        }
        
        function zoomOut() {
            showNotification('Zoom out', 'info');
        }
        
        function toggleFullscreen() {
            const mapContainer = document.querySelector('.map-container');
            if (!document.fullscreenElement) {
                mapContainer.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function showCustomerPopup(customerId, marker) {
            // Remove active class from all markers
            document.querySelectorAll('.customer-marker').forEach(m => m.classList.remove('active'));
            
            // Add active class to clicked marker
            marker.classList.add('active');
            
            // Show popup
            const popup = document.getElementById('customerPopup');
            const popupTitle = document.getElementById('popupTitle');
            const popupInfo = document.getElementById('popupInfo');
            const popupAddress = document.getElementById('popupAddress');
            
            // Real data from server
            const customers = {
                <% if (customers && customers.length > 0) { %>
                    <% customers.forEach(function(customer) { %>
                        '<%= customer.id || customer.phone %>': { 
                            name: '<%= customer.name || customer.username || "Nama tidak tersedia" %>', 
                            package: '<%= customer.package_name || "Paket tidak tersedia" %> - <%= customer.status === "active" ? "Aktif" : customer.status === "suspended" ? "Suspend" : customer.status === "pending" ? "Pending" : "Nonaktif" %>', 
                            address: '<%= customer.address || "Alamat tidak tersedia" %>',
                            phone: '<%= customer.phone || "No. telepon tidak tersedia" %>',
                            status: '<%= customer.status || "inactive" %>'
                        },
                    <% }); %>
                <% } %>
            };
            
            const customer = customers[customerId];
            if (customer) {
                popupTitle.textContent = customer.name;
                popupInfo.textContent = customer.package;
                popupAddress.textContent = customer.address;
                
                // Position popup near marker
                const rect = marker.getBoundingClientRect();
                const mapRect = document.querySelector('.map-container').getBoundingClientRect();
                
                popup.style.left = (rect.left - mapRect.left - 100) + 'px';
                popup.style.top = (rect.top - mapRect.top - 80) + 'px';
                popup.style.display = 'block';
            }
        }
        
        function viewCustomer() {
            showNotification('Membuka detail pelanggan...', 'info');
            // Implement view customer logic
        }
        
        function editCustomer() {
            showNotification('Membuka edit pelanggan...', 'info');
            // Implement edit customer logic
        }
        
        // Search and filter functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const filterTabs = document.querySelectorAll('.filter-tab');
            const markers = document.querySelectorAll('.customer-marker');
            
            // Search functionality
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterMarkers(searchTerm, getActiveFilter());
            });
            
            // Filter functionality
            filterTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    filterTabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Filter markers
                    const searchTerm = searchInput.value.toLowerCase();
                    filterMarkers(searchTerm, this.dataset.filter);
                });
            });
            
            // Close popup when clicking on map
            document.querySelector('.map-container').addEventListener('click', function(e) {
                if (e.target === this) {
                    document.getElementById('customerPopup').style.display = 'none';
                    document.querySelectorAll('.customer-marker').forEach(m => m.classList.remove('active'));
                }
            });
        });
        
        function getActiveFilter() {
            const activeTab = document.querySelector('.filter-tab.active');
            return activeTab ? activeTab.dataset.filter : 'all';
        }
        
        function filterMarkers(searchTerm, statusFilter) {
            const markers = document.querySelectorAll('.customer-marker');
            
            markers.forEach(marker => {
                const customerId = marker.dataset.customer;
                const isVisible = statusFilter === 'all' || marker.classList.contains('legend-' + statusFilter);
                
                if (isVisible) {
                    marker.style.display = 'block';
                } else {
                    marker.style.display = 'none';
                }
            });
        }
        
        // Add haptic feedback for markers
        if (navigator.vibrate) {
            document.querySelectorAll('.customer-marker').forEach(marker => {
                marker.addEventListener('click', function() {
                    navigator.vibrate(30);
                });
            });
        }
    </script>
</body>
</html>
