<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Device GenieACS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/dataTables.responsive.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <style>
        /* DataTables styling yang diperbaiki */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_processing,
        .dataTables_wrapper .dataTables_paginate {
            margin: 10px 0;
            display: block !important;
            visibility: visible !important;
        }
        .dataTables_wrapper .dataTables_filter {
            float: right;
            text-align: right;
            margin-bottom: 10px;
        }
        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            margin-left: 5px;
            width: 200px;
        }
        .dataTables_wrapper .dataTables_length {
            float: left;
            margin-bottom: 10px;
        }
        .dataTables_wrapper .dataTables_length select {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            margin: 0 5px;
        }
        .dataTables_wrapper .dataTables_paginate {
            float: right;
            margin-top: 10px;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            margin: 0 2px;
            cursor: pointer;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .dataTables_wrapper .dataTables_info {
            clear: both;
            float: left;
            padding-top: 10px;
        }
        /* Pastikan wrapper terlihat */
        .dataTables_wrapper {
            display: block !important;
            visibility: visible !important;
        }
    </style>
    <link href="/css/responsive-admin.css" rel="stylesheet">
    <style>
        body { background: #f5f6fa; }
        .form-label { font-weight: 600; }
        .main-content {
            padding: 32px 24px;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        /* Mobile responsive table styles */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        @media (max-width: 768px) {
            .table td, .table th {
                white-space: nowrap;
                min-width: 120px;
            }
            .table .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
        /* Fix z-index untuk mobile sidebar */
        .main-content {
            position: relative;
            z-index: 1;
        }
        .card {
            position: relative;
            z-index: 1;
        }
        .table-responsive {
            position: relative;
            z-index: 1;
        }
        .btn {
            position: relative;
            z-index: 1;
        }
        
        /* Pastikan mobile sidebar dan overlay memiliki z-index yang tepat */
        @media (max-width: 767.98px) {
            .main-content {
                z-index: 1;
                margin-top: 70px !important; /* Extra space for mobile navbar */
                padding-top: 10px !important;
            }
            .card {
                z-index: 1;
            }
            /* Pastikan cards tidak overlap dengan mobile navbar */
            .row.mb-4:first-of-type {
                margin-top: 10px;
            }
        }
        
        /* Styling untuk tombol aksi */
        .btn-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .btn-group-vertical .btn {
            border-radius: 4px !important;
            margin: 0;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            white-space: nowrap;
            min-width: 80px;
        }
        .btn-group-vertical .btn i {
            margin-right: 2px;
        }
        
        /* Responsive untuk tombol aksi */
        @media (max-width: 768px) {
            .btn-group-vertical .btn {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
                min-width: 70px;
            }
            .btn-group-vertical .btn i {
                margin-right: 1px;
            }
        }
        
        /* Pastikan kolom aksi tidak terlalu sempit */
        .table th:last-child,
        .table td:last-child {
            min-width: 120px;
            width: 120px;
        }
        /* Styling untuk tombol aksi horizontal */
        .btn-group {
            display: flex;
            flex-direction: row;
            gap: 2px;
        }
        .btn-group .btn {
            border-radius: 4px !important;
            margin: 0;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            white-space: nowrap;
            min-width: 70px;
            flex: 1;
        }
        .btn-group .btn:first-child {
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
        }
        .btn-group .btn:not(:first-child):not(:last-child) {
            border-radius: 0 !important;
        }
        .btn-group .btn:last-child {
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
        }
        
        /* Responsive untuk mobile */
        @media (max-width: 768px) {
            .btn-group .btn {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
<!-- Alert Container untuk Notifikasi -->
<div id="alert-container" style="position:fixed;top:70px;right:20px;z-index:1055;"></div>

<style>
/* Mobile alert positioning */
@media (max-width: 767.98px) {
    #alert-container {
        top: 80px !important; /* Below mobile navbar */
        right: 10px !important;
        left: 10px !important;
        width: auto !important;
    }
}
</style>

<div class="container-fluid">
    <div class="row">
        <!-- Include Responsive Admin Sidebar -->
        <%- include('partials/admin-responsive-sidebar', { page: 'genieacs', settings: settings }) %>

        <main class="col-md-10 main-content ms-sm-auto">
            <!-- GENIEACS CARDS: Statistik -->
            <div class="row mb-4">
              <div class="col-md-4 mb-3">
                <div class="card text-bg-primary">
                  <div class="card-body text-center">
                    <i class="bi bi-hdd-network fs-2 mb-2"></i>
                    <div class="fw-bold">Total Device GenieACS</div>
                    <div class="fs-3" id="genieacs-total"><%= typeof genieacsTotal !== 'undefined' ? genieacsTotal : '-' %></div>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card text-bg-success">
                  <div class="card-body text-center">
                    <i class="bi bi-wifi fs-2 mb-2"></i>
                    <div class="fw-bold">Device Online</div>
                    <div class="fs-3" id="genieacs-online"><%= typeof genieacsOnline !== 'undefined' ? genieacsOnline : '-' %></div>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card text-bg-danger">
                  <div class="card-body text-center">
                    <i class="bi bi-wifi-off fs-2 mb-2"></i>
                    <div class="fw-bold">Device Offline</div>
                    <div class="fs-3" id="genieacs-offline"><%= typeof genieacsOffline !== 'undefined' ? genieacsOffline : '-' %></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="mb-3"><i class="bi bi-hdd-network"></i> List Device GenieACS</h4>
                    <div class="table-responsive">
                        <table id="genieacsTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>PPPoE Username</th>
                                    <th>SSID</th>
                                    <th>User Konek</th>
                                    <th>Nomor Pelanggan</th>
                                    <th>RXPower</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% devices.forEach(function(device, i) { %>
                                <tr>
                                    <td><%= i+1 %></td>
                                    <td><%= device.pppoeUsername %></td>
                                    <td><%= device.ssid %></td>
                                    <td><%= device.userKonek %></td>
                                    <td><%= device.tag %></td>
                                    <td><%= typeof device.rxPower !== 'undefined' ? device.rxPower : '-' %></td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-warning edit-btn" data-id="<%= device.id %>" data-ssid="<%= device.ssid %>" data-password="<%= device.password %>" title="Edit SSID & Password"><i class="bi bi-pencil"></i> Edit SSID</button>
                                            <button class="btn btn-info edit-tag-btn" data-id="<%= device.id %>" data-tag="<%= device.tag || '' %>" title="Edit Tag"><i class="bi bi-tag"></i> Edit Tag</button>
                                            <button class="btn btn-danger restart-onu-btn" data-id="<%= device.id %>" data-serial="<%= device.serial %>" title="Restart ONU"><i class="bi bi-arrow-clockwise"></i> Restart</button>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- Modal Edit SSID/Password -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editForm" action="/admin/genieacs/edit" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit SSID & Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="editAlert" style="display:none;"></div>
          <input type="hidden" name="id" id="deviceId">
          <div class="mb-3">
            <label for="ssid" class="form-label">SSID</label>
            <input type="text" class="form-control" id="ssid" name="ssid">
            <button type="button" class="btn btn-success mt-2 w-100" id="saveSsidBtn">Simpan SSID</button>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="text" class="form-control" id="password" name="password">
            <button type="button" class="btn btn-primary mt-2 w-100" id="savePasswordBtn">Simpan Password</button>
          </div>
        </div>
        <div class="modal-footer d-flex flex-column align-items-stretch gap-2">
          <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Batal</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Scripts - hanya satu set jQuery dan Bootstrap -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function(){
    console.log('Document ready, initializing DataTable...');
    
    // Inisialisasi DataTables
    var table = $('#genieacsTable').DataTable({
        "responsive": true,
        "scrollX": true,
        "lengthMenu": [[20, 50, 100, -1], [20, 50, 100, "All"]],
        "pageLength": 20,
        "language": {
            "search": "Cari:",
            "lengthMenu": "Tampilkan _MENU_ data per halaman",
            "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
            "infoEmpty": "Menampilkan 0 sampai 0 dari 0 data",
            "infoFiltered": "(difilter dari _MAX_ total data)",
            "paginate": {
                "first": "Pertama",
                "last": "Terakhir",
                "next": "Selanjutnya",
                "previous": "Sebelumnya"
            }
        },
        "columnDefs": [
            { "targets": [0], "responsivePriority": 1 },
            { "targets": [1], "responsivePriority": 2 },
            { "targets": [-1], "responsivePriority": 3, "orderable": false }
        ]
    });
    
    console.log('DataTable initialized successfully');
    
    // Event delegation tombol edit
    $(document).on('click', '.edit-btn', function(){
        const id = $(this).data('id');
        const ssid = $(this).data('ssid');
        const password = $(this).data('password');
        $('#deviceId').val(id);
        $('#ssid').val(ssid);
        $('#password').val(password);
        var modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
    });

    // Fungsi alert dalam modal
    function showEditAlert(type, message) {
        $('#editAlert').removeClass().addClass('alert alert-' + type).html(message).show();
    }

    // Tombol simpan SSID
    $('#saveSsidBtn').on('click', function(e){
        e.preventDefault();
        const id = $('#deviceId').val();
        const ssid = $('#ssid').val();
        $.ajax({
            url: '/admin/genieacs/edit',
            method: 'POST',
            data: { id, ssid },
            success: function(res) {
                showEditAlert('success', 'SSID berhasil diupdate!');
                setTimeout(function(){ location.reload(); }, 1000);
            },
            error: function(err) {
                showEditAlert('danger', 'Gagal update SSID!');
            }
        });
    });

    // Tombol simpan Password
    $('#savePasswordBtn').on('click', function(e){
        e.preventDefault();
        const id = $('#deviceId').val();
        const password = $('#password').val();
        $.ajax({
            url: '/admin/genieacs/edit',
            method: 'POST',
            data: { id, password },
            success: function(res) {
                showEditAlert('success', 'Password berhasil diupdate!');
                setTimeout(function(){ location.reload(); }, 1000);
            },
            error: function(err) {
                showEditAlert('danger', 'Gagal update Password!');
            }
        });
    });

    // Modal kembali ke halaman pertama DataTables saat ditutup
    $('#editModal').on('hidden.bs.modal', function () {
        if (table && table.page) {
            table.page('first').draw('page');
        }
    });
    
    // Event handler untuk modal hidden - kembali ke halaman pertama DataTables
    $('#editModal').on('hidden.bs.modal', function () {
        if (table && table.page) {
            table.page('first').draw('page');
        }
    });
    
    // Fungsi notifikasi
    function showAlert(message, type) {
        var alert = $(`<div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`);
        $('#alert-container').append(alert);
        setTimeout(function(){ alert.alert('close'); }, 3000);
    }
});
</script>

<!-- Modal Edit Tag -->
<div class="modal fade" id="editTagModal" tabindex="-1" aria-labelledby="editTagModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editTagForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTagModalLabel">Edit Tag (Nomor Pelanggan)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="tagDeviceId" name="id">
          <div class="mb-3">
            <label for="newTag" class="form-label">Nomor Pelanggan</label>
            <input type="text" class="form-control" id="newTag" name="tag" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Restart ONU -->
<div class="modal fade" id="restartOnuModal" tabindex="-1" aria-labelledby="restartOnuModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="restartOnuModalLabel">Konfirmasi Restart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning" role="alert">
          <i class="bi bi-exclamation-triangle"></i> <strong>Peringatan!</strong>
        </div>
        <p>Apakah Anda yakin ingin restart device dengan Serial Number: <strong id="restartOnuSerial"></strong>?</p>
        <ul class="text-muted small">
          <li>ONU akan terputus sementara dari jaringan</li>
          <li>Pelanggan akan mengalami gangguan internet selama proses restart</li>
          <li>Proses restart biasanya memakan waktu 1-2 menit</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger" id="confirmRestartOnu">
          <i class="bi bi-arrow-clockwise"></i> Ya, Restart
        </button>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
  // Tombol Edit Tag
  $(document).on('click', '.edit-tag-btn', function() {
    const id = $(this).data('id');
    const tag = $(this).data('tag');
    $('#tagDeviceId').val(id);
    $('#newTag').val(tag !== '-' ? tag : '');
    $('#editTagModal').modal('show');
  });

  // Submit Edit Tag
  $('#editTagForm').submit(function(e) {
    e.preventDefault();
    const id = $('#tagDeviceId').val();
    const tag = $('#newTag').val();
    $.ajax({
      url: '/admin/genieacs/edit-tag',
      type: 'POST',
      data: { id, tag },
      success: function(res) {
        if (res.success) {
          location.reload();
        } else {
          alert('Gagal update tag: ' + (res.message || 'Unknown error'));
        }
      },
      error: function(xhr) {
        alert('Gagal update tag: ' + (xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Unknown error'));
      }
    });
  });

  // Tombol Restart ONU
  $(document).on('click', '.restart-onu-btn', function() {
    const id = $(this).data('id');
    const serial = $(this).data('serial');
    $('#restartOnuSerial').text(serial || id);
    $('#confirmRestartOnu').data('id', id);
    $('#restartOnuModal').modal('show');
  });

  // Konfirmasi Restart ONU
  $('#confirmRestartOnu').on('click', function() {
    const id = $(this).data('id');
    const $btn = $(this);
    const originalText = $btn.html();
    
    // Loading state
    $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Restarting...');
    
    $.ajax({
      url: '/admin/genieacs/restart-onu',
      type: 'POST',
      data: { id },
      success: function(res) {
        if (res.success) {
          $('#restartOnuModal').modal('hide');
          // Show success alert
          const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <i class="bi bi-check-circle"></i> ${res.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          $('.main-content').prepend(alertHtml);
          // Auto-hide alert after 5 seconds
          setTimeout(() => {
            $('.alert-success').fadeOut();
          }, 5000);
        } else {
          alert('Gagal restart: ' + (res.message || 'Unknown error'));
        }
      },
      error: function(xhr) {
        const errorMsg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Unknown error';
        alert('Gagal restart: ' + errorMsg);
      },
      complete: function() {
        // Reset button
        $btn.prop('disabled', false).html(originalText);
      }
    });
  });
});
</script>



<!-- Modal Konfirmasi Restart Mikrotik -->
<div class="modal fade" id="restartMikrotikModal" tabindex="-1" aria-labelledby="restartMikrotikModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="restartMikrotikModalLabel"><i class="bi bi-arrow-repeat"></i> Konfirmasi Restart Mikrotik</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Apakah Anda yakin ingin <b>restart Mikrotik</b>?<br>Router akan reboot dan koneksi internet pelanggan akan terputus sementara.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger" id="confirmRestartMikrotik">Restart</button>
      </div>
    </div>
  </div>
</div>

<!-- Notifikasi -->
<div id="restartNotif" class="alert d-none position-fixed top-0 end-0 m-4" style="z-index:9999; min-width:300px;"></div>

<script>
$(function() {
  $(document).on('click', '#restartMikrotikBtn', function(e) {
    e.preventDefault();
    $('#restartMikrotikModal').modal('show');
  });
  $('#confirmRestartMikrotik').on('click', function() {
    $('#restartMikrotikModal').modal('hide');
    $.ajax({
      url: '/admin/mikrotik/restart',
      method: 'POST',
      success: function(res) {
        let notif = $('#restartNotif');
        if(res.success) {
          notif.removeClass('d-none alert-danger').addClass('alert-success').text(res.message || 'Mikrotik berhasil direstart!');
        } else {
          notif.removeClass('d-none alert-success').addClass('alert-danger').text(res.message || 'Gagal restart Mikrotik!');
        }
        setTimeout(function() { notif.addClass('d-none'); }, 4000);
      },
      error: function() {
        let notif = $('#restartNotif');
        notif.removeClass('d-none alert-success').addClass('alert-danger').text('Gagal menghubungi server!');
        setTimeout(function() { notif.addClass('d-none'); }, 4000);
      }
    });
  });
});
</script>
</body>
</html>
